<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home Automation Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .badge-on { background-color: #28a745; }
    .badge-off { background-color: #dc3545; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Home Automation Dashboard</h1>
    <div>
      <span class="me-2">Logged in as: {{ request.user.username }}</span>
      <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <!-- Device Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">{{ device.name }} (ID: {{ device.device_id }})</h5>

      <!-- Controls -->
      <div class="d-flex gap-2 flex-wrap mb-3">
        <button type="button" 
                class="btn {% if device.desired_ch1 %}btn-success{% else %}btn-danger{% endif %}" 
                onclick="toggleChannel(1)">
          ROOM 1 LIGHT
        </button>
        <button type="button" 
                class="btn {% if device.desired_ch2 %}btn-success{% else %}btn-danger{% endif %}" 
                onclick="toggleChannel(2)">
          ROOM 2 LIGHT
        </button>
        <button type="button" 
                class="btn {% if device.desired_ch3 %}btn-success{% else %}btn-danger{% endif %}" 
                onclick="toggleChannel(3)">
          ROOM 3 LIGHT
        </button>
        <button type="button" 
                class="btn {% if device.desired_ch4 %}btn-success{% else %}btn-danger{% endif %}" 
                onclick="toggleChannel(4)">
          ROOM 4 LIGHT
        </button>
        <button type="button" class="btn btn-success" onclick="allChannels('on')">SWITCH ON ALL ROOM LIGHT</button>
        <button type="button" class="btn btn-danger" onclick="allChannels('off')">SWITCH OFF ALL ROOM LIGHT</button>
      </div>

      <!-- States -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <h6>Desired State</h6>
          <ul class="list-group" id="desired-state">
            <li class="list-group-item">CH1: <span class="badge {{ device.desired_ch1|yesno:'badge-on,badge-off' }}" id="ch1-state">{{ device.desired_ch1|yesno:"ON,OFF" }}</span></li>
            <li class="list-group-item">CH2: <span class="badge {{ device.desired_ch2|yesno:'badge-on,badge-off' }}" id="ch2-state">{{ device.desired_ch2|yesno:"ON,OFF" }}</span></li>
            <li class="list-group-item">CH3: <span class="badge {{ device.desired_ch3|yesno:'badge-on,badge-off' }}" id="ch3-state">{{ device.desired_ch3|yesno:"ON,OFF" }}</span></li>
            <li class="list-group-item">CH4: <span class="badge {{ device.desired_ch4|yesno:'badge-on,badge-off' }}" id="ch4-state">{{ device.desired_ch4|yesno:"ON,OFF" }}</span></li>
          </ul>
        </div>

        <div class="col-md-6 mb-3">
          <h6>Recent Device Reports</h6>
          <table class="table table-sm" id="report-table">
            <thead class="table-light"><tr><th>Time</th><th>CH1</th><th>CH2</th><th>CH3</th><th>CH4</th></tr></thead>
            <tbody>
              {% for r in reports %}
              <tr>
                <td>{{ r.created_at }}</td>
                <td>{{ r.ch1|yesno:"ON,OFF" }}</td>
                <td>{{ r.ch2|yesno:"ON,OFF" }}</td>
                <td>{{ r.ch3|yesno:"ON,OFF" }}</td>
                <td>{{ r.ch4|yesno:"ON,OFF" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-muted">No reports yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <p class="mt-3 text-muted">Last seen: <span id="last-seen">{{ device.last_seen }}</span></p>
    </div>
  </div>

  <div class="alert alert-info">
    <strong>Device API:</strong>
    <code>GET /api/device/&lt;device_id&gt;/desired/</code> and
    <code>POST /api/device/&lt;device_id&gt;/report/</code><br>
    Include header <code>X-DEVICE-TOKEN</code> with the shared token.
  </div>

</div>

<script>
  const DEVICE_ID = "{{ device.device_id }}";
  const TOKEN = "{{ DEVICE_SHARED_TOKEN }}";

  // CSRF token helper
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function postJSON(url, data={}) {
      const resp = await fetch(url, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-DEVICE-TOKEN': TOKEN
          },
          body: JSON.stringify(data)
      });
      if (!resp.ok) throw new Error(resp.statusText);
      return await resp.json();
  }

  async function fetchDesiredState() {
      try {
          const resp = await fetch(`/api/device/${DEVICE_ID}/desired/`, {
              headers: { 'X-DEVICE-TOKEN': TOKEN }
          });
          if (!resp.ok) throw new Error(resp.status);
          const data = await resp.json();
          if (!data.desired) return;

          // update badges
          ['ch1','ch2','ch3','ch4'].forEach(ch => {
              const elem = document.getElementById(`${ch}-state`);
              elem.textContent = data.desired[ch] ? 'ON' : 'OFF';
              elem.className = `badge ${data.desired[ch] ? 'badge-on' : 'badge-off'}`;
          });

          // update button colors
          ['ch1','ch2','ch3','ch4'].forEach((ch, idx) => {
              const btn = document.querySelector(`button[onclick="toggleChannel(${idx+1})"]`);
              if (btn) {
                  btn.className = `btn ${data.desired[ch] ? 'btn-success' : 'btn-danger'}`;
              }
          });

          // update last seen
          document.getElementById('last-seen').textContent = new Date(data.timestamp).toLocaleString();

          // update report table
          const tableBody = document.getElementById('report-table').querySelector('tbody');
          tableBody.innerHTML = '';
          data.reports?.forEach(r => {
              tableBody.insertAdjacentHTML('beforeend', `
                  <tr>
                      <td>${new Date(r.created_at).toLocaleString()}</td>
                      <td>${r.ch1 ? 'ON' : 'OFF'}</td>
                      <td>${r.ch2 ? 'ON' : 'OFF'}</td>
                      <td>${r.ch3 ? 'ON' : 'OFF'}</td>
                      <td>${r.ch4 ? 'ON' : 'OFF'}</td>
                  </tr>
              `);
          });
      } catch(err) {
          console.error(err);
      }
  }

  async function toggleChannel(ch) {
      try {
          await postJSON(`/device/${DEVICE_ID}/toggle/${ch}/`);
          fetchDesiredState();
      } catch(err) {
          console.error(err);
          alert('Failed to toggle channel ' + ch);
      }
  }

  async function allChannels(action) {
      try {
          await postJSON(`/device/${DEVICE_ID}/all/${action}/`);
          fetchDesiredState();
      } catch(err) {
          console.error(err);
          alert('Failed to set all channels ' + action);
      }
  }

  setInterval(fetchDesiredState, 3000);
  fetchDesiredState();
</script>
</body>
</html>
