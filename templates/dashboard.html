<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home Automation Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .badge-on { background-color: #28a745; }
    .badge-off { background-color: #dc3545; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Home Automation Dashboard</h1>
    <div>
      <span class="me-2">Logged in as: {{ request.user.username }}</span>
      <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <!-- Device Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">{{ device.name }} (ID: {{ device.device_id }})</h5>

      <!-- Controls -->
      <div class="d-flex gap-2 flex-wrap mb-3">
        {% for i in channels %}
          <button type="button" class="btn btn-primary" onclick="toggleChannel({{ i }})">ROOM {{ i }} LIGHT</button>
        {% endfor %}
        <button type="button" class="btn btn-success" onclick="allChannels('on')">SWITCH ON ALL</button>
        <button type="button" class="btn btn-danger" onclick="allChannels('off')">SWITCH OFF ALL</button>
      </div>

      <!-- States -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <h6>Desired State</h6>
          <ul class="list-group" id="desired-state">
            {% for i in channels %}
            <li class="list-group-item">
              CH{{ i }}: 
              <span class="badge" id="ch{{ i }}-state">--</span>
            </li>
            {% endfor %}
          </ul>
        </div>

        <div class="col-md-6 mb-3">
          <h6>Recent Device Reports</h6>
          <table class="table table-sm" id="report-table">
            <thead class="table-light">
              <tr>
                <th>Time</th>
                {% for i in channels %}
                  <th>CH{{ i }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for r in reports %}
              <tr>
                <td>{{ r.created_at }}</td>
                {% for ch in r.channels %}
                  <td>{{ ch|yesno:"ON,OFF" }}</td>
                {% endfor %}
              </tr>
              {% empty %}
              <tr><td colspan="11" class="text-muted">No reports yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <p class="mt-3 text-muted">Last seen: <span id="last-seen">{{ device.last_seen }}</span></p>
    </div>
  </div>

  <div class="alert alert-info">
    <strong>Device API:</strong>
    <code>GET /api/device/&lt;device_id&gt;/desired/</code> and
    <code>POST /api/device/&lt;device_id&gt;/report/</code><br>
    Include header <code>X-DEVICE-TOKEN</code> with the shared token.
  </div>

</div>

<script>
  const DEVICE_ID = "{{ device.device_id }}";
  const TOKEN = "{{ DEVICE_SHARED_TOKEN }}";

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function postJSON(url, data={}) {
      const resp = await fetch(url, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-DEVICE-TOKEN': TOKEN
          },
          body: JSON.stringify(data)
      });
      if (!resp.ok) throw new Error(resp.statusText);
      return await resp.json();
  }

  async function fetchDesiredState() {
      try {
          const resp = await fetch(`/api/device/${DEVICE_ID}/desired/`, {
              headers: { 'X-DEVICE-TOKEN': TOKEN }
          });
          if (!resp.ok) throw new Error(resp.status);
          const data = await resp.json();
          if (!data.desired) return;

          for (let i = 1; i <= 10; i++) {
              const ch = `ch${i}`;
              const elem = document.getElementById(`${ch}-state`);
              elem.textContent = data.desired[ch] ? 'ON' : 'OFF';
              elem.className = `badge ${data.desired[ch] ? 'badge-on' : 'badge-off'}`;
          }
          document.getElementById('last-seen').textContent = new Date(data.timestamp).toLocaleString();

          const tableBody = document.getElementById('report-table').querySelector('tbody');
          tableBody.innerHTML = '';
          data.reports?.forEach(r => {
              let row = `<tr><td>${new Date(r.created_at).toLocaleString()}</td>`;
              for (let i = 1; i <= 10; i++) {
                  row += `<td>${r[`ch${i}`] ? 'ON' : 'OFF'}</td>`;
              }
              row += '</tr>';
              tableBody.insertAdjacentHTML('beforeend', row);
          });
      } catch(err) {
          console.error(err);
      }
  }

  async function toggleChannel(ch) {
      try {
          await postJSON(`/device/${DEVICE_ID}/toggle/${ch}/`);
          fetchDesiredState();
      } catch(err) {
          console.error(err);
          alert('Failed to toggle channel ' + ch);
      }
  }

  async function allChannels(action) {
      try {
          await postJSON(`/device/${DEVICE_ID}/all/${action}/`);
          fetchDesiredState();
      } catch(err) {
          console.error(err);
          alert('Failed to set all channels ' + action);
      }
  }

  setInterval(fetchDesiredState, 3000);
  fetchDesiredState();
</script>
</body>
</html>
